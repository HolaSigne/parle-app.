<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parlé. | Speak your future</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        h1, h2, h3, .serif { font-family: 'Playfair Display', serif; }
        ::-webkit-scrollbar { width: 0px; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        
        /* Animations */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }
        
        /* 3D Card Flip */
        .perspective { perspective: 1000px; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col bg-gray-50">
    <div id="root" class="h-full w-full flex flex-col max-w-md mx-auto shadow-2xl overflow-hidden bg-white relative"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- UTILS ---
        const speakText = (text, langId) => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            const langMap = { 'fr': 'fr-FR', 'en': 'en-US', 'es': 'es-ES', 'it': 'it-IT', 'pt': 'pt-BR', 'de': 'de-DE', 'jp': 'ja-JP', 'cn': 'zh-CN', 'ru': 'ru-RU' };
            utterance.lang = langMap[langId] || 'en-US';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        };

        // --- DATA LAYER ---
        
        // Avatares 3D (Estilo Pixar/Memoji) - Incluyendo chica rubia sin turbante
        const AVATARS = [
            "https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_3.png",  // Chico con gafas
            "https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_32.png", // Chica profesional
            "https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_23.png", // Chica rubia pelo suelto
            "https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_10.png", // Chico rizos
            "https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_34.png", // Chica pelo largo oscuro
            "https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_29.png"  // Chico formal
        ];

        const PLANS = [
            { id: 'basic', name: 'Basic', price: '$0', features: ['Daily Lessons', 'Standard Support'], color: 'bg-gray-100' },
            { id: 'premium', name: 'Premium', price: '$9.99/mo', features: ['Unlimited Lives', 'AI Tutor Access', 'Offline Mode'], color: 'bg-emerald-100 border-emerald-500', recommended: true },
            { id: 'deluxe', name: 'Deluxe', price: '$19.99/mo', features: ['All Premium features', '1-on-1 Real Tutor', 'Certificate'], color: 'bg-purple-100 border-purple-500' }
        ];

        const LANGUAGES_LIST = [
            { id: 'fr', name: 'French', flag: 'fr' }, { id: 'en', name: 'English', flag: 'us' },
            { id: 'es', name: 'Spanish', flag: 'es' }, { id: 'it', name: 'Italian', flag: 'it' },
            { id: 'pt', name: 'Portuguese', flag: 'br' }, { id: 'de', name: 'German', flag: 'de' },
            { id: 'jp', name: 'Japanese', flag: 'jp' }, { id: 'cn', name: 'Chinese', flag: 'cn' },
            { id: 'ru', name: 'Russian', flag: 'ru' }
        ];

        const TUTOR_PERSONAS = {
            fr: { name: "Pierre", role: "Professeur", avatar: "P", greeting: "Bonjour. I am Pierre. Ready to explore French elegance?" },
            jp: { name: "Yuki", role: "Sensei", avatar: "Y", greeting: "Konnichiwa. Let us learn with respect." },
            en: { name: "Atlas", role: "Tutor", avatar: "A", greeting: "Hello! I'm Atlas. Ready to learn?" },
            es: { name: "Mateo", role: "Profesor", avatar: "M", greeting: "¡Hola! Vamos a practicar español." },
            it: { name: "Giulia", role: "Insegnante", avatar: "G", greeting: "Ciao! Ready for la dolce vita?" },
            pt: { name: "João", role: "Professor", avatar: "J", greeting: "Olá! Vamos falar português?" },
            de: { name: "Hanna", role: "Lehrerin", avatar: "H", greeting: "Hallo! Let's work on precision." },
            cn: { name: "Wei", role: "Laoshi", avatar: "W", greeting: "Ni hao. Mandarin is fascinating." },
            ru: { name: "Natasha", role: "Uchitel", avatar: "N", greeting: "Privet. Russian is beautiful." }
        };

        // NARRATIVE CULTURAL GUIDES
        const GUIDE_DETAILS = {
            1: { title: "Parisian Café", image: "https://images.unsplash.com/photo-1502602898657-3e91760cbb34?w=600", intro: "The café is a second living room for Parisians.", sections: [{title:"Ritual", content:"Sit, sip, observe. No rushing."}], etiquette: [{icon:"Coffee", text:"Say 'Bonjour' entering."}], slang: [{term:"Kawa", meaning:"Coffee"}] },
            2: { title: "Tokyo Streets", image: "https://images.unsplash.com/photo-1503899036084-c55cdd92da26?w=600", intro: "A blend of neon future and ancient tradition.", sections: [{title:"Order", content:"Vending machines are everywhere."}], etiquette: [{icon:"CheckCircle", text:"Quiet on trains."}], slang: [{term:"Konbini", meaning:"Convenience Store"}] },
            3: { title: "Roman History", image: "https://images.unsplash.com/photo-1552832230-c0197dd311b5?w=600", intro: "The Eternal City is an open-air museum.", sections: [{title:"Coffee", content:"Espresso at the bar."}], etiquette: [{icon:"Coffee", text:"No cappuccino after lunch."}], slang: [{term:"Aho", meaning:"Hey (Roman)"}] },
            4: { title: "London Life", image: "https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=600", intro: "Historic yet modern.", sections: [{title:"Tube", content:"Mind the gap."}], etiquette: [{icon:"Clock", text:"Stand on the right."}], slang: [{term:"Quid", meaning:"Pound (£)"}] },
            5: { title: "Berlin Vibes", image: "https://images.unsplash.com/photo-1560969184-10fe8719e654?w=600", intro: "Gritty, artistic, and free.", sections: [{title:"Kiez", content:"Your neighborhood."}], etiquette: [{icon:"Hand", text:"Directness is polite."}], slang: [{term:"Späti", meaning:"Late night shop"}] },
            6: { title: "Rio Energy", image: "https://images.unsplash.com/photo-1483729558449-99ef09a8c325?w=600", intro: "Sun, sea, and samba.", sections: [{title:"Beach", content:"It's a lifestyle."}], etiquette: [{icon:"Sun", text:"Thumbs up is common."}], slang: [{term:"Beleza?", meaning:"What's up?"}] },
            7: { title: "Madrid Nights", image: "https://images.unsplash.com/photo-1539037116277-4db20889f2d4?w=600", intro: "The city that never sleeps.", sections: [{title:"Tapas", content:"Share small plates."}], etiquette: [{icon:"Clock", text:"Dinner is late (9pm+)."}], slang: [{term:"Vale", meaning:"Okay"}] },
            8: { title: "Beijing Ancient", image: "https://images.unsplash.com/photo-1508804185872-d7badad00f7d?w=600", intro: "Imperial history meets modern power.", sections: [{title:"Hutongs", content:"Old alleyways."}], etiquette: [{icon:"Hand", text:"Two hands to give cards."}], slang: [{term:"Chi le ma?", meaning:"Have you eaten?"}] },
            9: { title: "Moscow Metro", image: "https://images.unsplash.com/photo-1513326738677-b964603b136d?w=600", intro: "Underground palaces.", sections: [{title:"Art", content:"Statues and chandeliers."}], etiquette: [{icon:"User", text:"Give seats to elders."}], slang: [{term:"Poka", meaning:"Bye"}] }
        };

        const GUIDES_BY_LANG = { fr: [1], jp: [2], it: [3], en: [4], de: [5], pt: [6], es: [7], cn: [8], ru: [9] };

        const COURSES_DATA = {
            fr: [
                { id: 1, type: 'visual_quiz', title: 'Objects', subtitle: 'Visual Vocab', status: 'available', data: { question: "Select 'Apple'", correct: "La Pomme", options: [{id:1, text:"La Pomme", img:"https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?w=200"}, {id:2, text:"Le Pain", img:"https://images.unsplash.com/photo-1509440159596-0249088772ff?w=200"}] } },
                { id: 2, type: 'flashcard', title: 'Verbs', subtitle: 'Flashcards', status: 'available', data: [{front:"Manger", back:"To Eat"}, {front:"Parler", back:"To Speak"}] },
                { id: 3, type: 'speaking', title: 'Pronunciation', subtitle: 'Speaking', status: 'available', phrase: "Je voudrais un croissant", wrongSim: "Je vudrai un crossan" },
                { id: 4, type: 'sentence_builder', title: 'Structure', subtitle: 'Builder', status: 'available', data: {target:"Je suis heureux", english:"I am happy", words:["Je","heureux","suis","triste"]} },
                { id: 5, type: 'reading', title: 'Culture', subtitle: 'Reading', status: 'available', data: {title:"La Tour Eiffel", text:"La Tour Eiffel est le symbole de Paris. Elle a été construite en 1889.", question:"When was it built?", answer:"1889", options:["1889","1900","1750"]} }
            ],
            jp: [
                { id: 1, type: 'visual_quiz', title: 'Food', subtitle: 'Visual Vocab', status: 'available', data: { question: "Select 'Sushi'", correct: "Sushi", options: [{id:1, text:"Sushi", img:"https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=200"}, {id:2, text:"Ramen", img:"https://images.unsplash.com/photo-1569718212165-3a8278d5f624?w=200"}] } },
                { id: 2, type: 'flashcard', title: 'Hiragana', subtitle: 'Flashcards', status: 'available', data: [{front:"あ", back:"A"}, {front:"い", back:"I"}] },
                { id: 3, type: 'speaking', title: 'Greetings', subtitle: 'Speaking', status: 'available', phrase: "Arigatou gozaimasu", wrongSim: "Arigato gozaimass" },
                { id: 4, type: 'listening', title: 'Listening', subtitle: 'Write it', status: 'available', phrase: "Sumimasen", translation: "Excuse me" }
            ],
            es: [
                { id: 1, type: 'visual_quiz', title: 'Elementos', subtitle: 'Visual', status: 'available', data: { question: "Select 'Water'", correct: "Agua", options: [{id:1, text:"Agua", img:"https://images.unsplash.com/photo-1548839140-29a749e1cf4d?w=200"}, {id:2, text:"Fuego", img:"https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=200"}] } },
                { id: 2, type: 'sentence_builder', title: 'Frases', subtitle: 'Builder', status: 'available', data: {target:"Hola como estas", english:"Hello how are you", words:["Hola","estas","como","bien"]} },
                { id: 3, type: 'speaking', title: 'Saludos', subtitle: 'Speaking', status: 'available', phrase: "Buenos días", wrongSim: "Buenos dias" }
            ],
            en: [
                { id: 1, type: 'visual_quiz', title: 'Transport', subtitle: 'Visual', status: 'available', data: { question: "Select 'Car'", correct: "Car", options: [{id:1, text:"Car", img:"https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=200"}, {id:2, text:"Bike", img:"https://images.unsplash.com/photo-1485965120184-e224f7a1adb1?w=200"}] } },
                { id: 2, type: 'speaking', title: 'Phrases', subtitle: 'Speaking', status: 'available', phrase: "Where is the station?", wrongSim: "Wer is de stayshun" }
            ],
            it: [
                { id: 1, type: 'visual_quiz', title: 'Cibo', subtitle: 'Visual', status: 'available', data: { question: "Select 'Pizza'", correct: "Pizza", options: [{id:1, text:"Pizza", img:"https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=200"}, {id:2, text:"Pasta", img:"https://images.unsplash.com/photo-1473093295043-cdd812d0e601?w=200"}] } },
                { id: 2, type: 'speaking', title: 'Saluti', subtitle: 'Speaking', status: 'available', phrase: "Un caffè per favore", wrongSim: "Un cafe per favor" }
            ],
            pt: [
                { id: 1, type: 'visual_quiz', title: 'Natureza', subtitle: 'Visual', status: 'available', data: { question: "Select 'Sun'", correct: "Sol", options: [{id:1, text:"Sol", img:"https://images.unsplash.com/photo-1501426026826-31c667bdf23d?w=200"}, {id:2, text:"Lua", img:"https://images.unsplash.com/photo-1522030299830-16b8d3d049fe?w=200"}] } },
                { id: 2, type: 'speaking', title: 'Frases', subtitle: 'Speaking', status: 'available', phrase: "Tudo bem?", wrongSim: "Tudo bem" }
            ],
            de: [
                { id: 1, type: 'visual_quiz', title: 'Stadt', subtitle: 'Visual', status: 'available', data: { question: "Select 'Train'", correct: "Zug", options: [{id:1, text:"Zug", img:"https://images.unsplash.com/photo-1474487548417-781cb71495f3?w=200"}, {id:2, text:"Auto", img:"https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=200"}] } },
                { id: 2, type: 'speaking', title: 'Hallo', subtitle: 'Speaking', status: 'available', phrase: "Wie geht es Ihnen?", wrongSim: "Vi get es inen" }
            ],
            cn: [
                { id: 1, type: 'flashcard', title: 'Basics', subtitle: 'Cards', status: 'available', data: [{front:"Ni hao", back:"Hello"}, {front:"Xie xie", back:"Thank you"}] },
                { id: 2, type: 'speaking', title: 'Tones', subtitle: 'Speaking', status: 'available', phrase: "Ni hao", wrongSim: "Ni how" }
            ],
            ru: [
                { id: 1, type: 'flashcard', title: 'Cyrillic', subtitle: 'Cards', status: 'available', data: [{front:"Привет", back:"Hi"}, {front:"Да", back:"Yes"}] },
                { id: 2, type: 'speaking', title: 'Basics', subtitle: 'Speaking', status: 'available', phrase: "Spasibo", wrongSim: "Spaseebo" }
            ]
        };

        // --- ICONS ---
        const Icon = ({ name, size = 20, className, strokeWidth = 2 }) => {
            const icons = {
                Home: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
                BookOpen: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
                Globe: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
                User: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
                Mic: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>,
                Volume2: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>,
                ChevronLeft: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>,
                X: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
                Play: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>,
                CheckCircle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
                Coffee: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" x2="6" y1="1" y2="4"/><line x1="10" x2="10" y1="1" y2="4"/><line x1="14" x2="14" y1="1" y2="4"/></svg>,
                Send: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
                MessageSquare: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
                Lock: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
                RotateCw: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>,
                Clock: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
                Camera: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
                Headphones: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></svg>,
                Edit3: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>,
                Layout: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></svg>,
                ChevronDown: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
            };
            return icons[name] || null;
        };

        // --- COMPONENTS ---

        const LockScreen = ({ onUnlock }) => {
            const [code, setCode] = useState('');
            const [error, setError] = useState(false);

            const handleUnlock = () => {
                if (code === 'Mundo') {
                    onUnlock();
                } else {
                    setError(true);
                    setTimeout(() => setError(false), 500);
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center p-8 animate-fade-in">
                    <div className="mb-8 p-6 bg-white/10 rounded-full backdrop-blur-md">
                        <Icon name="Lock" size={48} className="text-white" />
                    </div>
                    <h1 className="text-white text-2xl serif font-bold mb-2">Parlé Prototype</h1>
                    <p className="text-slate-400 text-sm mb-8">Enter passcode to unlock</p>
                    
                    <input 
                        type="password" 
                        value={code}
                        onChange={(e) => setCode(e.target.value)}
                        className={`w-full max-w-xs bg-slate-800 text-white text-center text-2xl tracking-widest py-4 rounded-xl border-2 outline-none mb-6 transition-all ${error ? 'border-red-500 shake' : 'border-slate-700 focus:border-emerald-500'}`}
                        placeholder="•••••"
                    />
                    
                    <button onClick={handleUnlock} className="w-full max-w-xs py-4 bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-bold rounded-xl transition-colors">
                        Unlock
                    </button>
                </div>
            );
        };

        const Onboarding = ({ onComplete }) => {
            const [step, setStep] = useState('welcome'); 
            const [formData, setFormData] = useState({ name: '', photo: null, plan: 'basic', email: '', password: '' });
            
            const handleLogin = () => {
                const existingUser = {
                    name: 'Alex Retour',
                    photo: 'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_23.png',
                    plan: 'Premium'
                };
                onComplete(existingUser);
            };

            if (step === 'welcome') {
                return (
                    <div className="h-full flex flex-col items-center justify-center p-8 bg-white text-center animate-fade-in">
                        <span className="serif text-6xl font-bold tracking-tighter text-slate-900 mb-6">Parlé<span className="text-emerald-500">.</span></span>
                        <h1 className="text-2xl font-light text-slate-600 mb-8">Speak your future.</h1>
                        <button onClick={() => setStep('profile')} className="w-full py-4 bg-slate-900 text-white rounded-xl font-medium hover:bg-slate-800 transition-all">Get Started</button>
                        <p className="mt-4 text-sm text-gray-400">Already have an account? <button onClick={() => setStep('login')} className="text-slate-900 font-bold cursor-pointer hover:underline">Log in</button></p>
                    </div>
                );
            }

            if (step === 'login') {
                return (
                    <div className="h-full flex flex-col p-8 bg-white animate-slide-up">
                        <button onClick={() => setStep('welcome')} className="mb-8"><Icon name="ChevronLeft" /></button>
                        <h2 className="text-3xl serif mb-2">Welcome Back</h2>
                        <p className="text-gray-500 mb-8">Please enter your details.</p>
                        <div className="space-y-6 mb-8">
                             <div>
                                <label className="block text-xs font-bold uppercase tracking-wider text-gray-400 mb-1">Email</label>
                                <input type="email" className="w-full border-b border-gray-200 py-2 outline-none focus:border-slate-900 text-lg" placeholder="hello@parle.com" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold uppercase tracking-wider text-gray-400 mb-1">Password</label>
                                <input type="password" className="w-full border-b border-gray-200 py-2 outline-none focus:border-slate-900 text-lg" placeholder="••••••••" />
                            </div>
                        </div>
                        <button onClick={handleLogin} className="mt-auto w-full py-4 bg-slate-900 text-white rounded-xl font-medium">Log In</button>
                    </div>
                );
            }

            if (step === 'profile') {
                return (
                    <div className="h-full flex flex-col p-8 bg-white animate-slide-up overflow-y-auto">
                        <button onClick={() => setStep('welcome')} className="mb-8"><Icon name="ChevronLeft" /></button>
                        <h2 className="text-3xl serif mb-2">Create Profile</h2>
                        <p className="text-gray-500 mb-8">Choose your avatar.</p>
                        <div className="grid grid-cols-3 gap-4 mb-8">
                            {AVATARS.map((avatar, i) => (
                                <div key={i} onClick={() => setFormData({...formData, photo: avatar})} className={`aspect-square rounded-full overflow-hidden cursor-pointer border-2 transition-all bg-gray-50 flex items-center justify-center ${formData.photo === avatar ? 'border-emerald-500 scale-110 shadow-md' : 'border-transparent hover:opacity-80'}`}>
                                    <img src={avatar} className="w-full h-full object-cover" />
                                </div>
                            ))}
                        </div>
                        <div className="space-y-4 mb-8">
                            <div>
                                <label className="block text-xs font-bold uppercase tracking-wider text-gray-400 mb-1">Name</label>
                                <input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full border-b border-gray-200 py-2 outline-none focus:border-slate-900 text-lg" placeholder="Enter your name" />
                            </div>
                        </div>
                        <button onClick={() => setStep('plans')} disabled={!formData.name || !formData.photo} className="mt-auto w-full py-4 bg-slate-900 text-white rounded-xl font-medium disabled:opacity-50">Continue</button>
                    </div>
                );
            }

            if (step === 'plans') {
                return (
                    <div className="h-full flex flex-col p-6 bg-white animate-slide-up overflow-y-auto">
                         <button onClick={() => setStep('profile')} className="mb-4"><Icon name="ChevronLeft" /></button>
                         <h2 className="text-2xl serif mb-6">Choose your Plan</h2>
                         <div className="space-y-4 mb-8">
                            {PLANS.map(plan => (
                                <div key={plan.id} onClick={() => setFormData({...formData, plan: plan.name})} className={`p-6 rounded-2xl border-2 cursor-pointer transition-all ${formData.plan === plan.name ? 'border-slate-900 shadow-xl scale-[1.02]' : 'border-transparent bg-gray-50'}`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-bold text-lg">{plan.name}</h3>
                                        <span className="text-sm font-medium bg-white px-2 py-1 rounded shadow-sm">{plan.price}</span>
                                    </div>
                                    <ul className="space-y-2 mb-4">
                                        {plan.features.map((f, i) => (<li key={i} className="text-xs text-gray-600 flex items-center gap-2"><div className="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div>{f}</li>))}
                                    </ul>
                                </div>
                            ))}
                         </div>
                         <div className="mt-auto pt-4 border-t border-gray-100">
                             <p className="text-center text-xs text-gray-400 mb-4">7-day free trial on Premium & Deluxe plans.</p>
                             <button onClick={() => onComplete(formData)} className="w-full py-4 bg-slate-900 text-white rounded-xl font-medium">Start Learning</button>
                         </div>
                    </div>
                );
            }
        };

        // 2. Activity Components
        const SpeakingPractice = ({ lesson, onExit, targetLang }) => {
            const [status, setStatus] = useState('idle'); 
            const [result, setResult] = useState(null);

            const handleMicClick = () => {
                if (status !== 'idle' && status !== 'feedback') return;
                setStatus('listening');
                setTimeout(() => {
                    setStatus('processing');
                    setTimeout(() => {
                        const randomScore = Math.floor(Math.random() * (100 - 60) + 60);
                        const isSuccess = randomScore > 80;
                        setResult({
                            score: randomScore,
                            type: isSuccess ? 'success' : 'correction',
                            feedback: isSuccess ? "Perfect pronunciation!" : "Watch your intonation."
                        });
                        setStatus('feedback');
                    }, 1500);
                }, 2000);
            };

            return (
                <div className="fixed inset-0 bg-white z-[60] flex flex-col max-w-md mx-auto animate-fade-in">
                    <div className="p-6 flex justify-between items-center border-b border-gray-50">
                        <button onClick={onExit}><Icon name="X" className="text-gray-400" /></button>
                        <span className="text-xs font-bold tracking-widest text-slate-900 uppercase">Speaking AI</span>
                        <div className="w-6"></div>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center p-8 text-center overflow-y-auto">
                        <span className="text-emerald-600 font-bold text-xs uppercase tracking-widest mb-6">Read & Speak</span>
                        <div className="mb-8">
                            <h2 className="text-3xl serif text-slate-900 mb-4 leading-tight">{lesson.phrase}</h2>
                            <button onClick={() => speakText(lesson.phrase, targetLang)} className="inline-flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-full text-sm font-medium text-slate-600 hover:bg-gray-100 transition-colors">
                                <Icon name="Volume2" size={16} /> Listen First
                            </button>
                        </div>
                        <div className="relative mb-8">
                            {status === 'listening' && <div className="absolute inset-0 flex items-center justify-center"><span className="absolute w-24 h-24 bg-red-100 rounded-full animate-ping opacity-75"></span><span className="absolute w-20 h-20 bg-red-200 rounded-full animate-pulse opacity-75"></span></div>}
                            <button onClick={handleMicClick} className={`relative w-20 h-20 rounded-full flex items-center justify-center transition-all duration-300 shadow-xl z-10 ${status === 'listening' ? 'bg-red-500 text-white scale-110' : 'bg-slate-900 text-white hover:scale-105'}`}>
                                <Icon name="Mic" size={32} />
                            </button>
                        </div>
                        {status === 'feedback' && (
                            <div className={`mt-4 w-full p-6 rounded-2xl animate-slide-up text-left border-l-4 ${result.type === 'success' ? 'bg-emerald-50 border-emerald-500' : 'bg-orange-50 border-orange-500'}`}>
                                <div className="flex justify-between items-start mb-2">
                                    <h3 className={`font-bold ${result.type === 'success' ? 'text-emerald-800' : 'text-orange-800'}`}>{result.type === 'success' ? 'Excellent!' : 'Keep Practicing'}</h3>
                                    <span className="text-2xl font-black opacity-50">{result.score}%</span>
                                </div>
                                {result.type === 'correction' && (<div className="mb-4"><p className="text-xs text-orange-600 uppercase font-bold mb-1">You said:</p><p className="text-slate-500 line-through decoration-red-400 decoration-2 text-lg">"{lesson.wrongSim}"</p></div>)}
                                <button onClick={() => setStatus('idle')} className="text-xs font-bold underline">Try Again</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const FlashcardExercise = ({ lesson, onExit }) => {
            const [index, setIndex] = useState(0);
            const [flipped, setFlipped] = useState(false);
            const card = lesson.data[index];
            const nextCard = () => { setFlipped(false); setTimeout(() => setIndex((prev) => (prev + 1) % lesson.data.length), 300); };

            return (
                <div className="fixed inset-0 bg-white z-[60] flex flex-col max-w-md mx-auto animate-fade-in">
                    <div className="p-6 flex justify-between items-center">
                        <button onClick={onExit}><Icon name="X" className="text-gray-400" /></button>
                        <span className="text-xs font-bold tracking-widest text-slate-900 uppercase">Flashcards</span>
                        <div className="w-6"></div>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center p-8 perspective">
                        <div className={`relative w-full aspect-[3/4] transition-all duration-500 transform-style-3d cursor-pointer ${flipped ? 'rotate-y-180' : ''}`} onClick={() => setFlipped(!flipped)}>
                            <div className="absolute inset-0 bg-slate-900 text-white rounded-3xl flex flex-col items-center justify-center p-8 shadow-2xl backface-hidden">
                                <span className="text-sm uppercase tracking-widest text-emerald-400 mb-4">Target</span>
                                <h2 className="text-4xl serif font-bold">{card.front}</h2>
                                <span className="absolute bottom-8 text-xs text-gray-400">Tap to flip</span>
                            </div>
                            <div className="absolute inset-0 bg-white border-2 border-slate-900 text-slate-900 rounded-3xl flex flex-col items-center justify-center p-8 shadow-2xl backface-hidden rotate-y-180">
                                <span className="text-sm uppercase tracking-widest text-gray-400 mb-4">English</span>
                                <h2 className="text-4xl serif font-bold">{card.back}</h2>
                            </div>
                        </div>
                    </div>
                    <div className="p-8"><button onClick={nextCard} className="w-full py-4 bg-gray-100 rounded-xl font-bold hover:bg-gray-200 transition-colors">Next Card</button></div>
                </div>
            );
        };

        const SentenceBuilder = ({ lesson, onExit }) => {
            const [currentWords, setCurrentWords] = useState([]);
            const [availableWords, setAvailableWords] = useState([...lesson.data.words].sort(() => Math.random() - 0.5));
            const [status, setStatus] = useState('idle'); 

            const addWord = (word) => { setCurrentWords([...currentWords, word]); setAvailableWords(availableWords.filter(w => w !== word)); setStatus('idle'); };
            const removeWord = (word) => { setAvailableWords([...availableWords, word]); setCurrentWords(currentWords.filter(w => w !== word)); setStatus('idle'); };
            const checkSentence = () => { if (currentWords.join(' ') === lesson.data.target) { setStatus('success'); } else { setStatus('error'); } };

            return (
                <div className="fixed inset-0 bg-white z-[60] flex flex-col max-w-md mx-auto animate-fade-in">
                    <div className="p-6 flex justify-between items-center">
                        <button onClick={onExit}><Icon name="X" className="text-gray-400" /></button>
                        <span className="text-xs font-bold tracking-widest text-slate-900 uppercase">Builder</span>
                        <div className="w-6"></div>
                    </div>
                    <div className="flex-1 flex flex-col p-8">
                        <h2 className="text-xl text-center text-gray-500 mb-8">"{lesson.data.english}"</h2>
                        <div className={`min-h-[100px] border-b-2 border-slate-200 mb-8 flex flex-wrap gap-2 p-4 items-start content-start transition-colors ${status === 'success' ? 'border-emerald-500 bg-emerald-50' : ''} ${status === 'error' ? 'border-red-500 bg-red-50' : ''}`}>
                             {currentWords.map((word, i) => (<button key={i} onClick={() => removeWord(word)} className="px-3 py-2 bg-white border border-slate-200 shadow-sm rounded-lg text-slate-900 font-medium animate-slide-up">{word}</button>))}
                        </div>
                        <div className="flex flex-wrap gap-3 justify-center">
                            {availableWords.map((word, i) => (<button key={i} onClick={() => addWord(word)} className="px-4 py-3 bg-slate-100 rounded-xl text-slate-700 font-medium hover:bg-slate-200 transition-colors">{word}</button>))}
                        </div>
                    </div>
                    <div className="p-8">
                         {status === 'success' ? ( <div className="w-full py-4 bg-emerald-500 text-white rounded-xl font-bold text-center flex items-center justify-center gap-2"><Icon name="CheckCircle" /> Correct!</div> ) : ( <button onClick={checkSentence} disabled={currentWords.length === 0} className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold disabled:opacity-50">Check Answer</button> )}
                    </div>
                </div>
            );
        };

        const ListeningExercise = ({ lesson, onExit, targetLang }) => {
            const [input, setInput] = useState('');
            const [status, setStatus] = useState('idle');
            const checkAnswer = () => { if (input.toLowerCase().trim() === lesson.phrase.toLowerCase().trim()) { setStatus('success'); } else { setStatus('error'); } };

            return (
                <div className="fixed inset-0 bg-white z-[60] flex flex-col max-w-md mx-auto animate-fade-in">
                    <div className="p-6 flex justify-between items-center">
                        <button onClick={onExit}><Icon name="X" className="text-gray-400" /></button>
                        <span className="text-xs font-bold tracking-widest text-slate-900 uppercase">Listening</span>
                        <div className="w-6"></div>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center p-8">
                        <button onClick={() => speakText(lesson.phrase, targetLang)} className="w-24 h-24 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mb-8 hover:scale-105 transition-transform cursor-pointer"><Icon name="Headphones" size={40} /></button>
                        <p className="text-sm text-gray-500 mb-8">Tap icon to listen, then write.</p>
                        <input type="text" value={input} onChange={(e) => {setInput(e.target.value); setStatus('idle');}} className="w-full text-center text-2xl border-b-2 border-slate-200 py-2 focus:border-slate-900 outline-none font-serif" placeholder="Type here..." />
                        {status === 'error' && <p className="mt-4 text-red-500 font-medium">Incorrect. Try: "{lesson.phrase}"</p>}
                    </div>
                    <div className="p-8">
                         {status === 'success' ? ( <div className="w-full py-4 bg-emerald-500 text-white rounded-xl font-bold text-center flex items-center justify-center gap-2"><Icon name="CheckCircle" /> Correct!</div> ) : ( <button onClick={checkAnswer} disabled={!input} className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold disabled:opacity-50">Check</button> )}
                    </div>
                </div>
            );
        };

        const ReadingExercise = ({ lesson, onExit }) => {
            const [selected, setSelected] = useState(null);
            const [status, setStatus] = useState('idle');
            const checkAnswer = (opt) => { setSelected(opt); setStatus(opt === lesson.data.answer ? 'success' : 'error'); };

            return (
                <div className="fixed inset-0 bg-white z-[60] flex flex-col max-w-md mx-auto animate-fade-in">
                    <div className="p-6 flex justify-between items-center">
                        <button onClick={onExit}><Icon name="X" className="text-gray-400" /></button>
                        <span className="text-xs font-bold tracking-widest text-slate-900 uppercase">Reading</span>
                        <div className="w-6"></div>
                    </div>
                    <div className="flex-1 flex flex-col p-8 overflow-y-auto">
                        <h2 className="text-2xl serif mb-4">{lesson.data.title}</h2>
                        <p className="text-lg leading-relaxed text-slate-600 mb-8">{lesson.data.text}</p>
                        <h3 className="font-bold mb-4 text-sm uppercase tracking-wide text-slate-400">Question: {lesson.data.question}</h3>
                        <div className="space-y-3">
                            {lesson.data.options.map(opt => (
                                <button key={opt} onClick={() => checkAnswer(opt)} className={`w-full p-4 rounded-xl border text-left transition-all ${selected === opt ? (status === 'success' ? 'bg-emerald-100 border-emerald-500 text-emerald-900' : 'bg-red-100 border-red-500 text-red-900') : 'border-gray-200 hover:bg-gray-50'}`}>{opt}</button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const VisualQuiz = ({ lesson, onExit }) => {
            const [selected, setSelected] = useState(null);
            const [isCorrect, setIsCorrect] = useState(null);
            const handleCheck = (id) => { setSelected(id); const correct = lesson.data.options.find(o => o.id === id).text === lesson.data.correct; setIsCorrect(correct); };

            return (
                <div className="fixed inset-0 bg-white z-[60] flex flex-col max-w-md mx-auto animate-fade-in">
                     <div className="p-6 flex justify-between items-center">
                        <button onClick={onExit}><Icon name="X" className="text-gray-400" /></button>
                        <span className="text-xs font-bold tracking-widest text-slate-900 uppercase">Visual Quiz</span>
                        <div className="w-6"></div>
                    </div>
                    <div className="flex-1 p-8 overflow-y-auto">
                        <h2 className="text-2xl serif text-center mb-8">{lesson.data.question}</h2>
                        <div className="grid grid-cols-2 gap-4">
                            {lesson.data.options.map(opt => (
                                <div key={opt.id} onClick={() => !selected && handleCheck(opt.id)} className={`relative aspect-square rounded-2xl overflow-hidden cursor-pointer border-4 transition-all ${selected === opt.id ? (isCorrect ? 'border-emerald-500' : 'border-red-500') : 'border-transparent hover:scale-105'}`}>
                                    <img src={opt.img} className="w-full h-full object-cover" />
                                    <div className="absolute bottom-0 inset-x-0 bg-black/50 text-white text-xs p-2 text-center backdrop-blur-sm">{selected && opt.text}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                    {selected && (
                        <div className={`p-6 ${isCorrect ? 'bg-emerald-100' : 'bg-red-100'}`}>
                            <p className={`text-center font-bold mb-4 ${isCorrect ? 'text-emerald-800' : 'text-red-800'}`}>{isCorrect ? 'Correct!' : 'Try Again'}</p>
                            <button onClick={onExit} className="w-full py-3 bg-white/50 rounded-xl font-bold">Continue</button>
                        </div>
                    )}
                </div>
            );
        };

        const GuideDetail = ({ guide, onBack }) => {
            if (!guide) return null;
            return (
                <div className="fixed inset-0 bg-white z-50 flex flex-col max-w-md mx-auto animate-fade-in overflow-y-auto">
                    <div className="relative h-80 shrink-0">
                        <img src={guide.image} className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                        <button onClick={onBack} className="absolute top-6 left-6 w-10 h-10 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-white hover:bg-white hover:text-slate-900 transition-colors"><Icon name="ChevronLeft" /></button>
                        <div className="absolute bottom-8 left-8 text-white pr-8"><span className="text-xs tracking-widest uppercase bg-emerald-500 px-2 py-1 rounded mb-3 inline-block">Cultural Guide</span><h2 className="text-4xl serif italic mb-2">{guide.title}</h2></div>
                    </div>
                    <div className="p-8 space-y-10">
                        <div><p className="text-lg leading-relaxed text-slate-700 font-light first-letter:text-5xl first-letter:font-serif first-letter:mr-2 first-letter:float-left first-letter:text-slate-900">{guide.intro}</p></div>
                        {guide.sections.map((sec, i) => (<div key={i} className="bg-gray-50 p-6 rounded-2xl border border-gray-100"><h3 className="serif text-xl mb-3 text-slate-900">{sec.title}</h3><p className="text-sm text-gray-600 leading-relaxed">{sec.content}</p></div>))}
                        <div><h3 className="text-xs font-bold text-slate-400 tracking-widest uppercase mb-6 flex items-center gap-2"><span className="w-8 h-[1px] bg-slate-400"></span> Local Etiquette</h3><div className="space-y-4">{guide.etiquette.map((item, i) => (<div key={i} className="flex gap-4 items-start"><div className="shrink-0 p-2 bg-slate-100 rounded-lg text-slate-900"><Icon name={item.icon} size={20} /></div><div><p className="text-sm text-slate-800 font-medium leading-relaxed">{item.text}</p></div></div>))}</div></div>
                    </div>
                </div>
            );
        };

        // 3. Main Views
        const ChatView = ({ targetLang }) => {
            const persona = TUTOR_PERSONAS[targetLang] || TUTOR_PERSONAS['en'];
            const [messages, setMessages] = useState([{ id: 1, sender: 'bot', text: persona.greeting }]);
            const [input, setInput] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => { setMessages([{ id: 1, sender: 'bot', text: persona.greeting }]); }, [targetLang]);
            useEffect(() => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }), [messages, isTyping]);

            const handleSend = () => {
                if (!input.trim()) return;
                const newMsg = { id: Date.now(), sender: 'user', text: input };
                setMessages(prev => [...prev, newMsg]);
                setInput('');
                setIsTyping(true);
                setTimeout(() => {
                    // Simulación de IA
                    const responses = [
                        `That's an interesting perspective on "${newMsg.text}". In ${targetLang.toUpperCase()}, we value that.`,
                        "Could you tell me more about that?",
                        "Excellent use of vocabulary. Keep going!",
                        "I understand. Learning a language takes time."
                    ];
                    const randomRes = responses[Math.floor(Math.random() * responses.length)];
                    setMessages(prev => [...prev, { id: Date.now()+1, sender: 'bot', text: randomRes }]);
                    setIsTyping(false);
                }, 1500);
            };

            return (
                <div className="flex flex-col h-full bg-white relative pb-24">
                    <div className="pt-4 px-6 pb-4 border-b border-gray-50 flex items-center gap-4 bg-white z-10 sticky top-0">
                        <div className="w-10 h-10 bg-slate-900 rounded-full flex items-center justify-center text-white shadow-lg"><span className="serif italic text-lg">{persona.avatar}</span></div>
                        <div><h2 className="text-lg font-medium serif text-slate-900">{persona.name}</h2><p className="text-xs text-emerald-600">Online • {persona.role}</p></div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-gray-50/50">
                        {messages.map(msg => (<div key={msg.id} className={`flex flex-col ${msg.sender === 'user' ? 'items-end' : 'items-start'} max-w-full animate-slide-up`}><div className={`p-4 rounded-2xl max-w-[85%] shadow-sm text-sm ${msg.sender === 'user' ? 'bg-slate-900 text-white rounded-tr-none' : 'bg-white text-slate-700 border border-gray-100 rounded-tl-none'}`}>{msg.text}</div></div>))}
                        {isTyping && <div className="p-4 bg-white rounded-2xl w-16 shadow-sm"><div className="flex gap-1"><div className="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div><div className="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div><div className="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div></div></div>}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className="absolute bottom-20 left-0 w-full p-4 bg-white/90 backdrop-blur border-t border-gray-50 flex gap-2 z-20">
                        <input type="text" value={input} onChange={e => setInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSend()} placeholder="Type a message..." className="flex-1 bg-gray-50 px-4 py-2 rounded-full outline-none text-sm border border-gray-200 focus:border-slate-900 transition-colors" />
                        <button onClick={handleSend} className="w-10 h-10 bg-slate-900 rounded-full text-white flex items-center justify-center"><Icon name="Send" size={16} /></button>
                    </div>
                </div>
            );
        };

        const ProfileView = ({ user }) => (
            <div className="px-8 py-12 h-full overflow-y-auto bg-white">
                <div className="text-center mb-8">
                    <div className="w-24 h-24 mx-auto bg-gray-100 rounded-full mb-4 overflow-hidden border-4 border-white shadow-lg relative">
                        <img src={user.photo} className="w-full h-full bg-gray-100" />
                        <div className="absolute bottom-0 right-0 w-6 h-6 bg-emerald-500 border-2 border-white rounded-full"></div>
                    </div>
                    <h2 className="text-2xl serif text-slate-900">{user.name}</h2>
                    <span className="px-3 py-1 bg-slate-900 text-white text-[10px] uppercase tracking-widest rounded-full mt-2 inline-block capitalize">{user.plan} Member</span>
                </div>
                <div className="grid grid-cols-2 gap-4 mb-8">
                    <div className="p-4 bg-gray-50 rounded-xl text-center border border-gray-100"><span className="block text-2xl font-bold text-slate-900">12</span><span className="text-xs text-gray-400 uppercase tracking-wider">Day Streak</span></div>
                    <div className="p-4 bg-gray-50 rounded-xl text-center border border-gray-100"><span className="block text-2xl font-bold text-slate-900">A2</span><span className="text-xs text-gray-400 uppercase tracking-wider">Global Level</span></div>
                </div>
                <button onClick={() => window.location.reload()} className="w-full py-3 border border-gray-200 text-slate-500 rounded-xl font-medium hover:text-red-500 hover:border-red-200 transition-colors">Log Out</button>
            </div>
        );

        const LanguageSwitcherModal = ({ isOpen, onClose, onSelect, current }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4 animate-fade-in">
                    <div className="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 max-h-[80vh] overflow-y-auto slide-up">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl serif font-bold">Select Language</h3>
                            <button onClick={onClose}><Icon name="X" /></button>
                        </div>
                        <div className="grid gap-3">
                            {LANGUAGES_LIST.map(lang => (
                                <button key={lang.id} onClick={() => { onSelect(lang.id); onClose(); }} className={`flex items-center gap-4 p-4 rounded-xl border-2 transition-all ${current === lang.id ? 'border-slate-900 bg-slate-50' : 'border-transparent hover:bg-gray-50'}`}>
                                    <img src={`https://flagcdn.com/w80/${lang.flag}.png`} className="w-10 h-8 rounded shadow-sm object-cover" />
                                    <span className="font-bold text-lg">{lang.name}</span>
                                    {current === lang.id && <div className="ml-auto text-emerald-500"><Icon name="CheckCircle" /></div>}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null); 
            const [activeTab, setActiveTab] = useState('home');
            const [currentLesson, setCurrentLesson] = useState(null);
            const [selectedGuideId, setSelectedGuideId] = useState(null);
            const [targetLang, setTargetLang] = useState('fr');
            const [showLangModal, setShowLangModal] = useState(false);
            const [isAppUnlocked, setIsAppUnlocked] = useState(false);

            if (!isAppUnlocked) {
                return <LockScreen onUnlock={() => setIsAppUnlocked(true)} />;
            }

            if (!user) return <Onboarding onComplete={(data) => setUser(data)} />;

            const currentLangObj = LANGUAGES_LIST.find(l => l.id === targetLang);

            return (
                <>
                    <main className="flex-1 relative h-full overflow-hidden flex flex-col">
                        {activeTab !== 'chat' && activeTab !== 'me' && (
                             <div className="pt-8 pb-4 px-6 bg-white z-10 sticky top-0 border-b border-gray-50 flex justify-between items-center">
                                <span className="serif text-2xl font-bold tracking-tighter text-slate-900">Parlé<span className="text-emerald-500">.</span></span>
                                <button onClick={() => setShowLangModal(true)} className="flex items-center gap-2 px-3 py-1 bg-slate-900 text-white rounded-full hover:bg-slate-800 transition-all shadow-md">
                                    <img src={`https://flagcdn.com/w40/${currentLangObj.flag}.png`} className="w-5 h-3.5 rounded-sm" />
                                    <span className="text-xs font-bold uppercase">{currentLangObj.name}</span>
                                    <Icon name="ChevronDown" size={14} />
                                </button>
                            </div>
                        )}
                        <div className="flex-1 overflow-hidden relative">
                             {activeTab === 'home' && (
                                <div className="h-full overflow-y-auto px-6 py-6 pb-32">
                                    <h2 className="text-3xl serif italic text-slate-900 mb-2">Bonjour, {user.name}</h2>
                                    <p className="text-sm text-gray-500 mb-8">Ready to master {currentLangObj.name}?</p>
                                    {(COURSES_DATA[targetLang] || []).map(course => (
                                        <div key={course.id} onClick={() => course.status !== 'locked' && setCurrentLesson(course)} className={`relative mb-4 p-6 bg-white rounded-xl border border-gray-100 shadow-sm flex justify-between items-center group cursor-pointer hover:border-slate-900 transition-all ${course.status === 'locked' ? 'opacity-60 grayscale' : ''}`}>
                                            <div><span className="text-xs font-bold text-emerald-600 tracking-widest block mb-1">{(course.type ? course.type.replace('_', ' ') : 'LESSON').toUpperCase()}</span><h3 className="text-xl serif font-medium text-slate-900">{course.title}</h3></div>
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${course.status === 'locked' ? 'bg-gray-100 text-gray-400' : 'bg-slate-900 text-white'}`}><Icon name={course.status === 'locked' ? 'Lock' : 'Play'} size={18} /></div>
                                        </div>
                                    ))}
                                </div>
                             )}
                             {activeTab === 'guides' && (
                                 <div className="h-full overflow-y-auto px-6 py-6 pb-32">
                                     <h2 className="text-3xl serif italic text-slate-900 mb-8">Cultural Guides</h2>
                                     {(GUIDES_BY_LANG[targetLang] || []).map(id => {
                                         // Simple mapping logic to ensure at least one guide per lang
                                         let guideData = null;
                                         if(targetLang === 'fr') guideData = GUIDE_DETAILS[1];
                                         if(targetLang === 'jp') guideData = GUIDE_DETAILS[2];
                                         if(targetLang === 'it') guideData = GUIDE_DETAILS[3];
                                         if(targetLang === 'en') guideData = GUIDE_DETAILS[4];
                                         if(targetLang === 'de') guideData = GUIDE_DETAILS[5];
                                         if(targetLang === 'pt') guideData = GUIDE_DETAILS[6];
                                         if(targetLang === 'es') guideData = GUIDE_DETAILS[7]; // Fixed index
                                         if(targetLang === 'cn') guideData = GUIDE_DETAILS[8]; // Fixed index
                                         if(targetLang === 'ru') guideData = GUIDE_DETAILS[9]; // Fixed index
                                         
                                         if(!guideData) return null;
                                         return (
                                             <div key={id} onClick={() => setSelectedGuideId(id)} className="relative h-64 rounded-2xl overflow-hidden cursor-pointer group mb-4">
                                                 <img src={guideData.image} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" /><div className="absolute inset-0 bg-black/20 group-hover:bg-black/10 transition-colors"></div>
                                                 <div className="absolute bottom-6 left-6 text-white"><h3 className="text-2xl serif italic">{guideData.title}</h3><p className="text-xs uppercase tracking-widest mt-2 border-b border-white/50 inline-block pb-1">Read Guide</p></div>
                                             </div>
                                         );
                                     })}
                                 </div>
                             )}
                             {activeTab === 'chat' && <ChatView targetLang={targetLang} />}
                             {activeTab === 'me' && <ProfileView user={user} />}
                        </div>
                    </main>
                    <div className="w-full bg-white/90 backdrop-blur-md h-20 fixed bottom-0 z-40 flex justify-around items-center px-4 pb-4 border-t border-gray-100 max-w-md">
                        {[{id:'home', icon:'Home', l:'Learn'}, {id:'guides', icon:'Globe', l:'Guides'}, {id:'chat', icon:'MessageSquare', l:'Tutor'}, {id:'me', icon:'User', l:'Profile'}].map(t => (
                            <button key={t.id} onClick={() => setActiveTab(t.id)} className={`flex flex-col items-center p-2 w-16 transition-all ${activeTab === t.id ? 'text-slate-900 -translate-y-1' : 'text-gray-300'}`}><Icon name={t.icon} size={24} strokeWidth={activeTab === t.id ? 2.5 : 2} /><span className="text-[10px] font-bold tracking-wider mt-1">{t.l}</span></button>
                        ))}
                    </div>
                    {/* Modals */}
                    <LanguageSwitcherModal isOpen={showLangModal} onClose={() => setShowLangModal(false)} onSelect={setTargetLang} current={targetLang} />
                    
                    {currentLesson?.type === 'speaking' && <SpeakingPractice lesson={currentLesson} targetLang={targetLang} onExit={() => setCurrentLesson(null)} />}
                    {currentLesson?.type === 'visual_quiz' && <VisualQuiz lesson={currentLesson} onExit={() => setCurrentLesson(null)} />}
                    {currentLesson?.type === 'flashcard' && <FlashcardExercise lesson={currentLesson} onExit={() => setCurrentLesson(null)} />}
                    {currentLesson?.type === 'sentence_builder' && <SentenceBuilder lesson={currentLesson} onExit={() => setCurrentLesson(null)} />}
                    {currentLesson?.type === 'listening' && <ListeningExercise lesson={currentLesson} targetLang={targetLang} onExit={() => setCurrentLesson(null)} />}
                    {currentLesson?.type === 'reading' && <ReadingExercise lesson={currentLesson} onExit={() => setCurrentLesson(null)} />}
                    
                    {selectedGuideId && <GuideDetail guide={GUIDE_DETAILS[targetLang === 'fr' ? 1 : targetLang === 'jp' ? 2 : targetLang === 'it' ? 3 : targetLang === 'en' ? 4 : targetLang === 'de' ? 5 : targetLang === 'pt' ? 6 : targetLang === 'es' ? 7 : targetLang === 'cn' ? 8 : 9]} onBack={() => setSelectedGuideId(null)} />}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
